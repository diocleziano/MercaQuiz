<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MercaQuiz.MVVM.Views.MateriaDettaglioPage"
             xmlns:vm="clr-namespace:MercaQuiz.MVVM.ViewModels"
             xmlns:models="clr-namespace:MercaQuiz.MVVM.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:DataType="vm:MateriaDettaglioViewModel"
             Title="{Binding Materia.Nome}">
    <!-- toolbar removed per user preference; add button in header instead -->

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="Gray300">#444444</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.Content>
        <!-- Root grid: header (row 0 auto) + list area (row 1 star) -->
        <Grid RowDefinitions="Auto,*" ColumnDefinitions="*" Padding="12" RowSpacing="10">

            <!-- Header area (row 0) -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,2*,*" ColumnSpacing="12" RowSpacing="6">
                <!-- Icon -->
                <Border Grid.Column="0" WidthRequest="56" HeightRequest="56" Stroke="{Binding Record.ColoreHex, Converter={StaticResource HexToBrushConverter}}" StrokeThickness="2" Background="Transparent">
                    <Label Text="{Binding Record.Icona}" FontSize="28" HorizontalOptions="Center" VerticalOptions="Center" TextColor="{Binding Record.ColoreHex, Converter={StaticResource HexToColorConverter}}">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label" Binding="{Binding Record.Icona}" Value="{x:Null}">
                                <Setter Property="Text" Value="ðŸ“š" />
                            </DataTrigger>
                            <DataTrigger TargetType="Label" Binding="{Binding Record.Icona}" Value="">
                                <Setter Property="Text" Value="ðŸ“š" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                </Border>

                <!-- Main info -->
                <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                    <Label Text="{Binding Record.Nome}" FontSize="20" FontAttributes="Bold" />
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding Record.Facolta}" IsVisible="{Binding Record.Facolta, Converter={StaticResource NullToBoolConverter}}" />
                        <Label Text="{Binding Record.Docente, StringFormat='Docente: {0}'}" IsVisible="{Binding Record.Docente, Converter={StaticResource NullToBoolConverter}}" />
                        <Label Text="{Binding Record.AnnoAccademico, StringFormat='Anno: {0}'}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>

                <!-- Right panel: quiz controls -->

                <Border StrokeThickness="1" Grid.Column="2" Padding="10" HorizontalOptions="End">
                    <VerticalStackLayout Spacing="6" HorizontalOptions="Center" VerticalOptions="Center">
                        <Label Text="QUIZ"/>
                        <HorizontalStackLayout Spacing="6">
                        <Label VerticalOptions="Center" Text="{Binding DomandeCount, StringFormat='Disponibili: {0}'}" HorizontalOptions="End" />
                            <Entry WidthRequest="80" Keyboard="Numeric" Text="{Binding NumeroDomandeRichieste}" HorizontalOptions="End" />
                            <Button Text="Avvia" Command="{Binding AvviaQuizCommand}" />
                        </HorizontalStackLayout>
                        <Picker ItemsSource="{Binding TipologiaItems}" SelectedIndex="{Binding SelectedTipologiaIndex}" Title="Tipologia" />
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!-- List area (row 1) -->
            <Grid Grid.Row="1" RowDefinitions="Auto,*" RowSpacing="5">
                <!-- Compact search + filter buttons row -->
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="5">
                    <SearchBar Grid.Column="0" Placeholder="Cerca domanda o risposta..." Text="{Binding SearchText}" />
                    <Button Grid.Column="1" Text="Tutte" Command="{Binding ShowTutteLeDomandeCommand}" />
                    <Button Grid.Column="2" Text="Fine lezione" Command="{Binding ShowDomandeFineLezioneCommand}" />
                    <Button Grid.Column="3" Text="Quiz" Command="{Binding ShowDomandeQuizCommand}" />

                    <!-- Right-side separate actions wrapped in a Border -->
                    <Border Grid.Column="4" Stroke="{StaticResource Gray300}" StrokeThickness="1" Padding="6" BackgroundColor="Transparent" HorizontalOptions="End">
                        <HorizontalStackLayout Spacing="8">
                            <Button Text="Reset Conteggi" Command="{Binding ResetConteggiCommand}" />
                            <Button Text="Aggiungi" Command="{Binding AggiungiDomandaCommand}" />
                        </HorizontalStackLayout>
                    </Border>
                </Grid>

                <!-- CollectionView in star row -->
                <CollectionView Grid.Row="1" ItemsSource="{Binding Domande}"
                                SelectionMode="None"
                                RemainingItemsThreshold="5"
                                RemainingItemsThresholdReachedCommand="{Binding LoadMoreDomandeAsyncCommand}"
                                VerticalOptions="FillAndExpand">
                    <CollectionView.EmptyView>
                        <Label Text="Nessuna domanda per questa materia." />
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:DomandaQuiz">
                            <Border Padding="12" Margin="0,4" StrokeThickness="1" Stroke="{StaticResource Gray300}" BackgroundColor="LightGray">
                                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                                    <Label Grid.ColumnSpan="3" Text="{Binding Domanda}" FontAttributes="Bold" LineBreakMode="WordWrap" />
                                    <Label Grid.Row="1" Text="{Binding RispostaCorrettaTesto}" FontSize="12" TextColor="Green" />
                                    <Label Grid.RowSpan="2" Grid.Column="1" VerticalOptions="Center" Text="{Binding ModuloAppartenenza}" FontSize="12" TextColor="Black" />
                                    <VerticalStackLayout Grid.RowSpan="2" Grid.Column="2" VerticalOptions="Center">
                                        <Label Text="Creata il" FontSize="12" TextColor="#555555" />
                                        <Label Text="{Binding CreatoIlUtc}" FontSize="12" TextColor="#555555" />
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.RowSpan="2" Grid.Column="3" VerticalOptions="Center">
                                        <Label Text="{Binding IndovinataNrVolte, StringFormat='Nr. volte indovinata: {0}'}" FontSize="12" TextColor="Green" />
                                        <Label Text="{Binding SbagliataNrVolte, StringFormat='Nr. volte sbagliata: {0}'}" FontSize="12" TextColor="DarkRed" />
                                    </VerticalStackLayout>

                                    <HorizontalStackLayout Grid.Column="4" Grid.RowSpan="2" Spacing="6">
                                        <Button Text="Modifica" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ModificaDomandaCommand}" CommandParameter="{Binding .}" />
                                        <Button Text="Elimina" Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EliminaDomandaCommand}" CommandParameter="{Binding .}" />
                                    </HorizontalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- overlay when loading -->
                <BoxView Grid.RowSpan="2" BackgroundColor="Transparent" IsVisible="{Binding IsLoading}" />
                <ActivityIndicator Grid.RowSpan="2" IsRunning="{Binding IsLoading}" IsVisible="{Binding IsLoading}" HorizontalOptions="Center" VerticalOptions="Center" />
            </Grid>
        </Grid>
    </ContentPage.Content>
</ContentPage>